{% extends 'app/layout.html' %}
{% load humanize %}
{% block extra_head %}
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - Dark Style</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" />
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const chartData = {{ chart_data|safe }};
            const PieData = {{ data|safe }};

            // Example of how to use the data in a chart (replace with actual charting code)
            console.log('Chart Data:', chartData);
            console.log('Pie Data:', PieData);

            // Your existing AJAX call
            $.ajax({
                url: '/Dashboard/',
                type: 'POST',
                data: {
                    csrfmiddlewaretoken: getCookie('csrftoken'),  // Replace with your cookie retrieval function
                    chart_data: chartData,
                    pdata: PieData,
                },
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')  // Replace with your cookie retrieval function
                },
                success: function (response) {
                    // Handle the response
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error('Error:', textStatus, errorThrown);
                }
            });

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
    </script>
</head>
{% endblock %}

{% load static %}

{% block content %}


{% if user.is_authenticated %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const selectedProjectId = "{{ project.id }}";  // Current project ID from Django context
        if (selectedProjectId) {
            const options = document.querySelectorAll('#project_name option');
            options.forEach(option => {
                if (option.getAttribute('data-project-id') === selectedProjectId) {
                    option.selected = true;
                }
            });
        }
    });
</script>


<body>
    <form method="GET" action="{% url 'Dashboard' %}">
        <label for="project_name">Select Project:</label>
        <select id="project_name" name="project_name">
            <option value="">--Select a Project--</option>
            {% for proj in projects %}
            <option value="{{ proj.id }}" data-project-id="{{ proj.id }}">{{ proj.name }}</option>
            {% endfor %}
        </select>
        <button type="submit">Filter</button>
    </form>
    <form method="GET" action="{% url 'generate_excel_report' %}">
        <label for="report_type">Select Report Type:</label>
        <select id="report_type" name="type">
            <option value="labour">Labour Report</option>
            <option value="inventory">Inventory Report</option>
            <option value="groupeditems">Grouped Items Report</option>
            <option value="issueitem">Issue Item Report</option>
            <option value="tasks">Tasks Report</option> <!-- Added this option -->
        </select>

        <input type="hidden" name="name" value="{{ project.name }}">

        <button type="submit" class="btn btn-primary">Generate Report</button>
    </form>


    <div id="wrapper">
        <div class="content-area">
            <div class="container-fluid">
                <div class="main">
                    <div class="row sparkboxes mt-4">
                        <div class="col-md-4">
                            <div class="box box1">
                                <h1><strong>{{ labour_total|floatformat:"2"|intcomma }} Ksh </strong></h1>
                                <h2 style="font-weight: bold;">Labour Total</h2>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="box box2">
                                <h1><strong>{{ invt_total|floatformat:"2"|intcomma }} Ksh </strong></h1>
                                <h2 style="font-weight: bold;">Inventory Total</h2>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="box box3">
                                <h1><strong>{{ labour_num|intcomma }} Ksh </strong></h1>
                                <h2 style="font-weight: bold;">Total Labourers</h2>
                            </div>
                        </div>

                    </div>


                    <br>

                    <div class="row mt-4">
                        <div class="col-md-5">
                            <div class="box shadow mt-4">
                                <canvas id="piechart">
                                </canvas>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <div class="chart">
                                <div class="box shadow mt-4">
                                    <canvas id="barchart"></canvas>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
    var chartData = {{ chart_data|safe }};
    var PieData = {{ data|safe}}
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.slim.min.js"></script>
    <script src="{% static 'app/scripts/Dashboard.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</body>



{% endif %}

{% endblock %}
